<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AutoCare360 - Dashboard</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        .dashboard-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 20px;
            backdrop-filter: blur(20px);
            margin-top: 2rem;
        }
        
        .dashboard-header {
            text-align: center;
            margin-bottom: 2rem;
            color: #ffffff;
        }
        
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-top: 2rem;
        }
        
        .dashboard-card {
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 1.5rem;
            color: #ffffff;
        }
        
        .card-icon {
            font-size: 2rem;
            color: #00d4ff;
            margin-bottom: 1rem;
        }
        
        .logout-btn {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #ff4444;
            color: white;
            border: none;
            padding: 0.8rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .logout-btn:hover {
            background: #cc3333;
            transform: translateY(-2px);
        }
    </style>
</head>
<body>
    <!-- Background Particles -->
    <div id="particles-js"></div>
    
    <!-- Neural Network Background -->
    <div class="neural-network">
        <div class="neural-node" style="top: 10%; left: 15%;"></div>
        <div class="neural-node" style="top: 20%; left: 80%;"></div>
        <div class="neural-node" style="top: 60%; left: 10%;"></div>
        <div class="neural-node" style="top: 70%; left: 85%;"></div>
        <div class="neural-node" style="top: 30%; left: 50%;"></div>
        <div class="neural-connection" style="top: 15%; left: 20%; width: 300px; transform: rotate(25deg);"></div>
        <div class="neural-connection" style="top: 45%; left: 30%; width: 250px; transform: rotate(-15deg);"></div>
        <div class="neural-connection" style="top: 65%; left: 40%; width: 200px; transform: rotate(45deg);"></div>
    </div>

    <button class="logout-btn" onclick="logout()">
        <i class="fas fa-sign-out-alt"></i> Logout
    </button>

    <div class="dashboard-container">
        <div class="dashboard-header">
            <h1>Welcome to AutoCare360 Dashboard</h1>
            <p id="welcomeMessage">Loading...</p>
        </div>

        <div class="dashboard-grid">
            <div class="dashboard-card">
                <div class="card-icon">
                    <i class="fas fa-user"></i>
                </div>
                <h3>Profile Information</h3>
                <div id="profileInfo">Loading...</div>
            </div>

            <div class="dashboard-card">
                <div class="card-icon">
                    <i class="fas fa-car"></i>
                </div>
                <h3>Vehicle Information</h3>
                <div id="vehicleInfo">Loading...</div>
            </div>

            <div class="dashboard-card">
                <div class="card-icon">
                    <i class="fas fa-chart-line"></i>
                </div>
                <h3>Vehicle Status</h3>
                <div id="vehicleStatus">Loading...</div>
            </div>

            <div class="dashboard-card">
                <div class="card-icon">
                    <i class="fas fa-wrench"></i>
                </div>
                <h3>Maintenance</h3>
                <div id="maintenanceInfo">Loading...</div>
            </div>

            <div class="dashboard-card">
                <div class="card-icon">
                    <i class="fas fa-tachometer-alt"></i>
                </div>
                <h3>Performance</h3>
                <div id="performanceInfo">Loading...</div>
            </div>

            <div class="dashboard-card">
                <div class="card-icon">
                    <i class="fas fa-leaf"></i>
                </div>
                <h3>Eco Tips</h3>
                <div id="ecoTips">Loading...</div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/particles.js/2.0.0/particles.min.js"></script>
    <script>
        // Initialize particles
        if (typeof particlesJS !== 'undefined') {
            particlesJS('particles-js', {
                particles: {
                    number: { value: 40, density: { enable: true, value_area: 800 } },
                    color: { value: "#00d4ff" },
                    shape: { type: "circle" },
                    opacity: { value: 0.3, random: true },
                    size: { value: 2, random: true },
                    line_linked: {
                        enable: true,
                        distance: 150,
                        color: "#00d4ff",
                        opacity: 0.2,
                        width: 1
                    },
                    move: {
                        enable: true,
                        speed: 2,
                        direction: "none",
                        random: true,
                        straight: false,
                        out_mode: "out",
                        bounce: false
                    }
                },
                interactivity: {
                    detect_on: "canvas",
                    events: {
                        onhover: { enable: true, mode: "repulse" },
                        onclick: { enable: true, mode: "push" },
                        resize: true
                    },
                    modes: {
                        repulse: { distance: 100, duration: 0.4 },
                        push: { particles_nb: 2 }
                    }
                },
                retina_detect: true
            });
        }

        // Dashboard functionality
        document.addEventListener('DOMContentLoaded', function() {
            checkAuthentication();
            loadDashboardData();
        });

        function checkAuthentication() {
            const authData = localStorage.getItem('autocare360_auth') || 
                            sessionStorage.getItem('autocare360_auth');
            
            if (!authData) {
                window.location.href = '/login';
                return;
            }

            try {
                const parsed = JSON.parse(authData);
                if (!parsed.token || !parsed.user) {
                    throw new Error('Invalid auth data');
                }

                // Display welcome message
                const welcomeMsg = document.getElementById('welcomeMessage');
                if (welcomeMsg) {
                    welcomeMsg.textContent = `Welcome back, ${parsed.user.firstName} ${parsed.user.lastName}!`;
                }

                // Display profile info
                const profileInfo = document.getElementById('profileInfo');
                if (profileInfo) {
                    profileInfo.innerHTML = `
                        <p><strong>Name:</strong> ${parsed.user.firstName} ${parsed.user.lastName}</p>
                        <p><strong>Email:</strong> ${parsed.user.email}</p>
                    `;
                }

                // Display vehicle info
                const vehicleInfo = document.getElementById('vehicleInfo');
                if (vehicleInfo && parsed.user.vehicle) {
                    vehicleInfo.innerHTML = `
                        <p><strong>Vehicle:</strong> ${parsed.user.vehicle.year} ${parsed.user.vehicle.make} ${parsed.user.vehicle.model}</p>
                        <p><strong>Type:</strong> ${parsed.user.vehicle.type}</p>
                        <p><strong>Fuel:</strong> ${parsed.user.vehicle.fuelType}</p>
                        <p><strong>Mileage:</strong> ${parsed.user.vehicle.currentMileage.toLocaleString()} miles</p>
                    `;
                }

            } catch (err) {
                console.error('Auth error:', err);
                logout();
            }
        }

        async function loadDashboardData() {
            try {
                const authData = localStorage.getItem('autocare360_auth') || 
                                sessionStorage.getItem('autocare360_auth');
                
                if (!authData) return;

                const parsed = JSON.parse(authData);
                
                const response = await fetch('/api/dashboard', {
                    headers: {
                        'Authorization': `Bearer ${parsed.token}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    console.log('ðŸ“Š Dashboard data:', data);
                    
                    // Update vehicle status with real data
                    const statusEl = document.getElementById('vehicleStatus');
                    if (statusEl && data.vehicleData) {
                        const statusColor = data.vehicleData.engineStatus === 'Optimal' ? '#00ff88' : 
                                           data.vehicleData.engineStatus === 'Check Required' ? '#ff6b35' : '#ff4444';
                        
                        statusEl.innerHTML = `
                            <p><strong>Engine:</strong> <span style="color: ${statusColor};">${data.vehicleData.engineStatus}</span></p>
                            <p><strong>Battery:</strong> ${data.vehicleData.batteryHealth}% (${data.vehicleData.batteryVoltage}V)</p>
                            <p><strong>Mileage:</strong> ${data.vehicleData.mileage.toLocaleString()} km</p>
                            <p><strong>Fuel Efficiency:</strong> ${data.vehicleData.fuelEfficiency} L/100km</p>
                        `;
                    }

                    // Update maintenance info with real data
                    const maintenanceEl = document.getElementById('maintenanceInfo');
                    if (maintenanceEl && data.vehicleData) {
                        const nextServiceColor = data.vehicleData.nextServiceKm < 1000 ? '#ff4444' : '#00d4ff';
                        
                        maintenanceEl.innerHTML = `
                            <p><strong>Next Service:</strong> <span style="color: ${nextServiceColor};">${data.vehicleData.nextServiceKm} km</span></p>
                            <p><strong>Oil Life:</strong> ${data.vehicleData.oilLife}%</p>
                            <p><strong>Brake Pads:</strong> ${data.vehicleData.brakePads}%</p>
                            <p><strong>Tire Condition:</strong> ${data.vehicleData.tireCondition}</p>
                        `;
                    }

                    // Update vehicle info with combined data
                    const vehicleInfo = document.getElementById('vehicleInfo');
                    if (vehicleInfo && data.user.vehicle && data.vehicleData) {
                        vehicleInfo.innerHTML = `
                            <p><strong>Vehicle:</strong> ${data.user.vehicle.year} ${data.user.vehicle.make} ${data.user.vehicle.model}</p>
                            <p><strong>Type:</strong> ${data.user.vehicle.type}</p>
                            <p><strong>Fuel:</strong> ${data.user.vehicle.fuelType}</p>
                            <p><strong>Color:</strong> ${data.user.vehicle.color}</p>
                            <p><strong>Current Mileage:</strong> ${data.vehicleData.mileage.toLocaleString()} km</p>
                        `;
                    }

                    // Show critical alerts if any
                    if (data.vehicleData.criticalAlerts && data.vehicleData.criticalAlerts.length > 0) {
                        showCriticalAlerts(data.vehicleData.criticalAlerts);
                    }

                    // Show upcoming tasks
                    if (data.vehicleData.upcomingTasks && data.vehicleData.upcomingTasks.length > 0) {
                        showUpcomingTasks(data.vehicleData.upcomingTasks);
                    }

                    // Update performance info
                    const performanceEl = document.getElementById('performanceInfo');
                    if (performanceEl && data.vehicleData) {
                        const scoreColor = data.vehicleData.drivingScore >= 8 ? '#00ff88' : 
                                          data.vehicleData.drivingScore >= 6 ? '#ffa500' : '#ff4444';
                        
                        performanceEl.innerHTML = `
                            <p><strong>Driving Score:</strong> <span style="color: ${scoreColor};">${data.vehicleData.drivingScore}/10</span></p>
                            <p><strong>Fuel Efficiency:</strong> ${data.vehicleData.fuelEfficiency} L/100km</p>
                            <p><strong>Coolant Level:</strong> ${data.vehicleData.coolantLevel}%</p>
                            <p><strong>Air Filter:</strong> ${data.vehicleData.airFilterHealth}%</p>
                        `;
                    }

                    // Update eco tips
                    const ecoTipsEl = document.getElementById('ecoTips');
                    if (ecoTipsEl && data.vehicleData && data.vehicleData.ecoTips) {
                        ecoTipsEl.innerHTML = `
                            ${data.vehicleData.ecoTips.map(tip => `
                                <p style="margin: 0.5rem 0; padding: 0.3rem; background: rgba(0,255,136,0.1); border-radius: 4px; font-size: 0.9rem;">
                                    <i class="fas fa-lightbulb" style="color: #00ff88; margin-right: 0.5rem;"></i>${tip}
                                </p>
                            `).join('')}
                        `;
                    }

                } else {
                    console.error('Failed to load dashboard data:', response.status);
                    if (response.status === 401) {
                        // Token expired, logout
                        logout();
                    }
                }
            } catch (err) {
                console.error('Dashboard load error:', err);
            }
        }

        function showCriticalAlerts(alerts) {
            const alertContainer = document.createElement('div');
            alertContainer.className = 'critical-alerts';
            alertContainer.style.cssText = `
                position: fixed;
                top: 80px;
                right: 20px;
                background: rgba(255, 68, 68, 0.9);
                color: white;
                padding: 1rem;
                border-radius: 8px;
                max-width: 300px;
                z-index: 1000;
                border-left: 4px solid #ff4444;
            `;
            
            alertContainer.innerHTML = `
                <h4 style="margin: 0 0 0.5rem 0; display: flex; align-items: center; gap: 0.5rem;">
                    <i class="fas fa-exclamation-triangle"></i> Critical Alerts
                </h4>
                ${alerts.map(alert => `<p style="margin: 0.3rem 0; font-size: 0.9rem;">â€¢ ${alert}</p>`).join('')}
            `;
            
            document.body.appendChild(alertContainer);
            
            setTimeout(() => {
                alertContainer.remove();
            }, 10000);
        }

        function showUpcomingTasks(tasks) {
            const taskContainer = document.createElement('div');
            taskContainer.className = 'upcoming-tasks';
            taskContainer.style.cssText = `
                position: fixed;
                top: 80px;
                left: 20px;
                background: rgba(0, 212, 255, 0.9);
                color: white;
                padding: 1rem;
                border-radius: 8px;
                max-width: 300px;
                z-index: 1000;
                border-left: 4px solid #00d4ff;
            `;
            
            taskContainer.innerHTML = `
                <h4 style="margin: 0 0 0.5rem 0; display: flex; align-items: center; gap: 0.5rem;">
                    <i class="fas fa-calendar-check"></i> Upcoming Tasks
                </h4>
                ${tasks.map(task => `<p style="margin: 0.3rem 0; font-size: 0.9rem;">â€¢ ${task}</p>`).join('')}
            `;
            
            document.body.appendChild(taskContainer);
            
            setTimeout(() => {
                taskContainer.remove();
            }, 8000);
        }

        function logout() {
            localStorage.removeItem('autocare360_auth');
            sessionStorage.removeItem('autocare360_auth');
            window.location.href = '/login';
        }
    </script>
</body>
</html>
